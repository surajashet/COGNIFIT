<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onboarding | CogniFit</title>

    <!-- Font Awesome and Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- ✅ Use Flask url_for for static CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="onboard-container">
        

        <div class="onboard-panel">
            <div class="onboard-header">
                <div class="brand-logo">
                    <!-- ✅ Flask static for logo -->
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="CogniFit Logo">
                </div>
                <h1>Let's Personalize Your Journey</h1>
                <p>Tell us a little about yourself so we can tailor the perfect plan.</p>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>
            <div class="step-counter"><span id="currentStep">1</span> of <span id="totalSteps">3</span></div>

            <!-- ✅ Flask form POST to /onboarding -->
            <form class="onboard-form" id="onboardForm" method="POST" action="{{ url_for('onboarding') }}">
                
                <!-- STEP 1 -->
                <div class="onboard-step active-step" data-step="1">
                    <h2>What are your main fitness goals?</h2>
                    <p>Select all that apply.</p>
                    
                    <div class="choice-grid">
                        <label class="choice-card">
                            <input type="checkbox" name="goal" value="lose_weight">
                            <i class="fas fa-weight-scale"></i>
                            <span>Lose Weight</span>
                        </label>
                        <label class="choice-card">
                            <input type="checkbox" name="goal" value="build_muscle">
                            <i class="fas fa-dumbbell"></i>
                            <span>Build Muscle</span>
                        </label>
                        <label class="choice-card">
                            <input type="checkbox" name="goal" value="get_fitter">
                            <i class="fas fa-running"></i>
                            <span>Get Fitter</span>
                        </label>
                        <label class="choice-card">
                            <input type="checkbox" name="goal" value="improve_health">
                            <i class="fas fa-heart-pulse"></i>
                            <span>Improve Health</span>
                        </label>
                    </div>
                </div>

                <!-- STEP 2 -->
                <div class="onboard-step" data-step="2">
                    <h2>How active are you currently?</h2>
                    <p>This helps us set a safe starting point.</p>
                    
                    <div class="choice-list">
                        <label class="radio-card">
                            <input type="radio" name="activity" value="sedentary" required>
                            <span><i class="fas fa-couch"></i> Sedentary: Little or no exercise.</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="activity" value="lightly_active">
                            <span><i class="fas fa-walking"></i> Lightly Active: 1-3 days/week.</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="activity" value="moderately_active">
                            <span><i class="fas fa-person-walking"></i> Moderately Active: 3-5 days/week.</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="activity" value="very_active">
                            <span><i class="fas fa-person-running"></i> Very Active: 6-7 days/week.</span>
                        </label>
                    </div>
                </div>

                <!-- STEP 3 -->
                <div class="onboard-step" data-step="3">
                    <h2>Your Current Metrics</h2>
                    <p>Enter your current weight, height, and age to calculate your initial BMI/BMR.</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="age">Age</label>
                            <div class="input-with-icon">
                                <i class="fas fa-cake-candles"></i>
                                <input type="number" id="age" name="age" placeholder="e.g., 30" min="16" max="100" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="height">Height (cm)</label>
                            <div class="input-with-icon">
                                <i class="fas fa-ruler-vertical"></i>
                                <input type="number" id="height" name="height" placeholder="e.g., 175" min="100" max="250" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="weight">Weight (kg)</label>
                            <div class="input-with-icon">
                                <i class="fas fa-weight-hanging"></i>
                                <input type="number" id="weight" name="weight" placeholder="e.g., 70" min="20" max="300" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group-full">
                        <label for="injury">Are you managing any injuries or health conditions?</label>
                        <div class="input-with-icon">
                            <i class="fas fa-stethoscope"></i>
                            <input type="text" id="injury" name="injury" placeholder="e.g., Knee pain, High blood pressure (optional)">
                        </div>
                    </div>
                </div>

                <div class="onboard-navigation">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-back" id="backToDashboardBtn" style="display: none;">
                        <i class="fas fa-home"></i> Back to Dashboard
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
                        Finish Setup <i class="fas fa-check"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ✅ Updated JavaScript with back button functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('onboardForm');
            const steps = document.querySelectorAll('.onboard-step');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const backToDashboardBtn = document.getElementById('backToDashboardBtn');
            const progressBar = document.getElementById('progressBar');
            const currentStepSpan = document.getElementById('currentStep');
            const totalStepsSpan = document.getElementById('totalSteps');
            let currentStep = 1;
            const totalSteps = steps.length;

            totalStepsSpan.textContent = totalSteps;
            
            function updateProgress() {
                const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
                progressBar.style.width = `${progress}%`;
                currentStepSpan.textContent = currentStep;
                
                // Show/hide navigation buttons
                prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
                backToDashboardBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
                
                if (currentStep === totalSteps) {
                    nextBtn.style.display = 'none';
                    submitBtn.style.display = 'inline-flex';
                } else {
                    nextBtn.style.display = 'inline-flex';
                    submitBtn.style.display = 'none';
                }
                
                // Update active step
                steps.forEach(step => {
                    step.classList.remove('active-step');
                    if (parseInt(step.getAttribute('data-step')) === currentStep) {
                        step.classList.add('active-step');
                    }
                });
            }

            nextBtn.addEventListener('click', function() {
                if (currentStep < totalSteps) {
                    currentStep++;
                    updateProgress();
                }
            });

            prevBtn.addEventListener('click', function() {
                if (currentStep > 1) {
                    currentStep--;
                    updateProgress();
                }
            });

            backToDashboardBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to leave? Your progress will be saved.')) {
                    window.location.href = "{{ url_for('dashboard') }}";
                }
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                // ✅ Convert form data to JSON-like object
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.goals = Array.from(form.querySelectorAll('input[name="goal"]:checked')).map(el => el.value);

                // Send data to backend
                fetch('{{ url_for("onboarding") }}', {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = "{{ url_for('dashboard') }}";
                    } else {
                        alert('Something went wrong while saving your data.');
                    }
                })
                .catch(error => console.error('Error:', error));
            });

            // Add visual feedback for checked items
            document.querySelectorAll('.choice-card input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        this.closest('.choice-card').style.borderColor = 'var(--secondary-color)';
                        this.closest('.choice-card').style.backgroundColor = 'rgba(174, 82, 58, 0.05)';
                    } else {
                        this.closest('.choice-card').style.borderColor = '#e0e0e0';
                        this.closest('.choice-card').style.backgroundColor = 'var(--text-light)';
                    }
                });
            });

            document.querySelectorAll('.radio-card input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.radio-card').forEach(card => {
                        card.style.borderColor = '#e0e0e0';
                        card.style.backgroundColor = 'var(--text-light)';
                    });
                    if (this.checked) {
                        this.closest('.radio-card').style.borderColor = 'var(--secondary-color)';
                        this.closest('.radio-card').style.backgroundColor = 'rgba(174, 82, 58, 0.05)';
                    }
                });
            });

            updateProgress();
        });
    </script>
</body>
</html>